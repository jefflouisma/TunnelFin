<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TunnelFin Configuration</title>
</head>
<body>
    <div data-role="page" id="tunnelfinConfigurationPage" class="page type-interior pluginConfigurationPage">
        <div data-role="content">
            <div class="content-primary">
                <form id="tunnelfinForm">
                    <!-- Header -->
                    <div class="verticalSection">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h2 class="sectionTitle">TunnelFin - Privacy-First Torrent Streaming</h2>
                        </div>
                        <p class="sectionDescription">
                            Configure anonymous torrent streaming, content discovery, and advanced filtering.
                        </p>
                    </div>

                    <!-- Privacy Settings -->
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Privacy & Anonymity</h3>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="defaultHopCount">Default Hop Count (1-3)</label>
                            <input type="number" id="defaultHopCount" name="defaultHopCount" min="1" max="3" step="1" class="emby-input" />
                            <div class="fieldDescription">Number of relay hops for anonymity circuits. Higher = more privacy, slower speed.</div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label>
                                <input type="checkbox" id="enableBandwidthContribution" name="enableBandwidthContribution" is="emby-checkbox" />
                                <span>Enable Bandwidth Contribution</span>
                            </label>
                            <div class="fieldDescription">Contribute bandwidth to the Tribler network (proportional to usage).</div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label>
                                <input type="checkbox" id="allowNonAnonymousFallback" name="allowNonAnonymousFallback" is="emby-checkbox" />
                                <span>Allow Non-Anonymous Fallback</span>
                            </label>
                            <div class="fieldDescription">Allow direct connections when Tribler network is unavailable (requires consent per session).</div>
                        </div>
                    </div>

                    <!-- Streaming Settings -->
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Streaming</h3>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="maxConcurrentStreams">Max Concurrent Streams (1-10)</label>
                            <input type="number" id="maxConcurrentStreams" name="maxConcurrentStreams" min="1" max="10" step="1" class="emby-input" />
                            <div class="fieldDescription">Maximum number of simultaneous torrent streams.</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel" for="maxCacheSize">Max Cache Size (GB)</label>
                            <input type="number" id="maxCacheSize" name="maxCacheSize" min="1" max="100" step="1" class="emby-input" />
                            <div class="fieldDescription">Maximum disk space for torrent data cache.</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel" for="minimumBufferSeconds">Minimum Buffer (seconds)</label>
                            <input type="number" id="minimumBufferSeconds" name="minimumBufferSeconds" min="5" max="60" step="5" class="emby-input" />
                            <div class="fieldDescription">Minimum buffer duration before playback starts.</div>
                        </div>
                    </div>

                    <!-- Content Discovery -->
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Content Discovery</h3>
                        
                        <div class="inputContainer">
                            <label class="inputLabel" for="maxConcurrentSearches">Max Concurrent Searches (1-10)</label>
                            <input type="number" id="maxConcurrentSearches" name="maxConcurrentSearches" min="1" max="10" step="1" class="emby-input" />
                            <div class="fieldDescription">Maximum number of simultaneous indexer searches.</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel" for="searchCacheDurationMinutes">Search Cache Duration (minutes)</label>
                            <input type="number" id="searchCacheDurationMinutes" name="searchCacheDurationMinutes" min="5" max="60" step="5" class="emby-input" />
                            <div class="fieldDescription">How long to cache search results.</div>
                        </div>
                    </div>

                    <!-- Filter Profiles -->
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Filter Profiles</h3>
                        <p class="sectionDescription">
                            Configure separate filter profiles for Movies, TV Shows, and Anime.
                            Profiles allow you to set quality preferences, codec filters, and more.
                        </p>
                        <div class="fieldDescription">
                            <strong>Note:</strong> Filter profile management will be available in a future update.
                            For now, configure global filtering preferences below.
                        </div>
                    </div>

                    <!-- Logging -->
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Logging</h3>
                        
                        <div class="selectContainer">
                            <label class="inputLabel" for="loggingLevel">Logging Level</label>
                            <select id="loggingLevel" name="loggingLevel" class="emby-select">
                                <option value="0">Minimal (Privacy-Aware)</option>
                                <option value="1">Verbose (Debugging)</option>
                            </select>
                            <div class="fieldDescription">Minimal logging excludes PII and content titles for privacy.</div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div>
                        <button id="btnSave" is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            (function () {
                const pluginId = "A7F8B3C2-1D4E-4A5B-9C6D-7E8F9A0B1C2D";
                const page = document.querySelector('#tunnelfinConfigurationPage');
                const form = document.querySelector('#tunnelfinForm');

                // Form elements
                const defaultHopCount = document.querySelector('#defaultHopCount');
                const enableBandwidthContribution = document.querySelector('#enableBandwidthContribution');
                const allowNonAnonymousFallback = document.querySelector('#allowNonAnonymousFallback');
                const maxConcurrentStreams = document.querySelector('#maxConcurrentStreams');
                const maxCacheSize = document.querySelector('#maxCacheSize');
                const minimumBufferSeconds = document.querySelector('#minimumBufferSeconds');
                const maxConcurrentSearches = document.querySelector('#maxConcurrentSearches');
                const searchCacheDurationMinutes = document.querySelector('#searchCacheDurationMinutes');
                const loggingLevel = document.querySelector('#loggingLevel');

                // Load configuration
                async function loadConfig() {
                    Dashboard.showLoadingMsg();
                    try {
                        const cfg = await window.ApiClient.getPluginConfiguration(pluginId);

                        defaultHopCount.value = cfg.DefaultHopCount || 3;
                        enableBandwidthContribution.checked = cfg.EnableBandwidthContribution !== false;
                        allowNonAnonymousFallback.checked = cfg.AllowNonAnonymousFallback === true;
                        maxConcurrentStreams.value = cfg.MaxConcurrentStreams || 3;
                        maxCacheSize.value = Math.round((cfg.MaxCacheSize || 10737418240) / 1073741824); // Convert bytes to GB
                        minimumBufferSeconds.value = cfg.MinimumBufferSeconds || 10;
                        maxConcurrentSearches.value = cfg.MaxConcurrentSearches || 5;
                        searchCacheDurationMinutes.value = cfg.SearchCacheDurationMinutes || 10;
                        loggingLevel.value = cfg.LoggingLevel || 0;
                    } catch (e) {
                        console.error('Failed to load configuration:', e);
                        Dashboard.alert('Failed to load configuration. Please try again.');
                    } finally {
                        Dashboard.hideLoadingMsg();
                    }
                }

                // Save configuration
                async function saveConfig(e) {
                    e.preventDefault();
                    Dashboard.showLoadingMsg();
                    try {
                        const cfg = await window.ApiClient.getPluginConfiguration(pluginId);

                        cfg.DefaultHopCount = parseInt(defaultHopCount.value) || 3;
                        cfg.EnableBandwidthContribution = enableBandwidthContribution.checked;
                        cfg.AllowNonAnonymousFallback = allowNonAnonymousFallback.checked;
                        cfg.MaxConcurrentStreams = parseInt(maxConcurrentStreams.value) || 3;
                        cfg.MaxCacheSize = (parseInt(maxCacheSize.value) || 10) * 1073741824; // Convert GB to bytes
                        cfg.MinimumBufferSeconds = parseInt(minimumBufferSeconds.value) || 10;
                        cfg.MaxConcurrentSearches = parseInt(maxConcurrentSearches.value) || 5;
                        cfg.SearchCacheDurationMinutes = parseInt(searchCacheDurationMinutes.value) || 10;
                        cfg.LoggingLevel = parseInt(loggingLevel.value) || 0;

                        await window.ApiClient.updatePluginConfiguration(pluginId, cfg);
                        Dashboard.processPluginConfigurationUpdateResult();
                    } catch (e) {
                        console.error('Failed to save configuration:', e);
                        Dashboard.alert('Failed to save configuration. Please check your settings and try again.');
                    } finally {
                        Dashboard.hideLoadingMsg();
                    }
                }

                // Event listeners
                form.addEventListener('submit', saveConfig);
                page.addEventListener('pageshow', loadConfig);
            })();
        </script>
    </div>
</body>
</html>


